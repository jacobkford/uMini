@inject UserManager<ApplicationUser> UserManager
@model PaginatedList<UserViewModel>
@{
    ViewData["Title"] = "Manage Users";
}

<!-- Header -->
<div class="px-sm-5 py-4">
    <div class="container">
        <div class="row justify-content-between align-items-center">
            <!-- Title -->
            <div class="col">
                <h1 class="mb-0 h3">@ViewData["Title"]</h1> 
            </div>
        </div>
    </div>
</div>
<!-- Content -->
<div class="container-fluid px-sm-5">
    <div class="row">
        <div class="col-12">
            <!-- Card -->
            <div class="card mb-4">
                <!-- Card Body -->
                <div class="card-body border-bottom py-3">
                    <div class="d-flex align-items-center">
                        <!-- Page size -->
                        <div class="text-muted">
                            Show
                            <div class="mx-2 d-inline-block">
                                <form 
                                    method="get" 
                                    asp-area="Admin" 
                                    asp-controller="Users" 
                                    asp-action="Index"
                                >
                                    <select
                                        name="size" 
                                        id="pageSize" 
                                        class="form-select form-select-sm" 
                                        asp-items="(List<SelectListItem>?)@ViewData["PageSizeList"]" 
                                        onchange="this.form.submit();"
                                    >
                                    </select>
                                </form>
                            </div>
                            entries
                        </div>
                        <!-- Search box -->
                        <div class="ms-auto text-muted">
                            <form 
                                method="get" 
                                asp-area="Admin" 
                                asp-controller="Users" 
                                asp-action="Index"
                            >
                                <div class="input-group">                  
                                    <div class="form-outline flex-grow-1 flex-lg-grow-0">
                                        <input id="search-input" type="search" value="@ViewData["CurrentFilter"]" class="form-control" />
                                        <label class="form-label" for="search-input">Search</label>
                                    </div>
                                    <button type="submit" value="Search" class="btn btn-outline-dark">
                                        <i class="fas fa-search"></i>
                                    </button>   
                                </div> 
                            </form>
                        </div>
                    </div>
                </div>
                <!-- Table -->
                <div class="table-responsive">
                    <table class="mx-auto table text-nowrap mb-0 bg-white">
                        <thead class="bg-light">
                            <tr>
                                <th scope="col">
                                    <a
                                        class="text-decoration-none text-reset"
                                        asp-area="Admin" 
                                        asp-controller="Users" 
                                        asp-action="Index"
                                        asp-route-sort="@ViewData["NameSortParm"]" 
                                        asp-route-filter="@ViewData["CurrentFilter"]"
                                    >
                                        Name
                                        @{
                                            if (string.IsNullOrEmpty((string?)ViewData["CurrentSort"]))
                                            {
                                                <i class="fas fa-sort-up"></i>
                                            }
                                            else if ((string?)ViewData["CurrentSort"] == "name_desc")
                                            {
                                                <i class="fas fa-sort-down"></i>
                                            }
                                        }
                                    </a>
                                </th>
                                <th scope="col">
                                    <a 
                                        class="text-decoration-none text-reset"
                                        asp-area="Admin" 
                                        asp-controller="Users" 
                                        asp-action="Index"
                                        asp-route-sort="@ViewData["EmailSortParm"]" 
                                        asp-route-filter="@ViewData["CurrentFilter"]"
                                    >
                                        Email
                                        @{
                                            if ((string?)ViewData["CurrentSort"] == "email")
                                            {
                                                <i class="fas fa-sort-up"></i>
                                            }
                                            else if ((string?)ViewData["CurrentSort"] == "email_desc")
                                            {
                                                <i class="fas fa-sort-down"></i>
                                            }
                                        }
                                    </a>
                                </th>
                                <th scope="col">Roles</th>
                                <th scope="col"></th>
                            </tr>
                        </thead>
                        <tbody class="border-top-0">
                            @foreach(var user in Model)
                            {
                                <tr>
                                    <td>
                                        @Html.DisplayFor(modelItem => user.UserName)
                                    </td>
                                    <td>
                                        @Html.DisplayFor(modelItem => user.Email)
                                    </td>
                                    <td>
                                        <div class="d-flex flex-wrap">
                                            @await Component.InvokeAsync("ApplicationUserRoleChips", new { userId = user.Id, contextUser = User })
                                        </div>
                                    </td>
                                    <td>
                                        @if (User.IsInRole(ApplicationUserRole.SuperAdmin)
                                           || (!User.IsInRole(ApplicationUserRole.SuperAdmin) && !user.Roles.Any(role => 
                                                role == ApplicationUserRole.SuperAdmin || role == ApplicationUserRole.Admin)))
                                        {
                                            <div class="dropdown">
                                                <a
                                                class="d-flex align-items-center text-decoration-none text-muted"
                                                role="button"
                                                id="dropdownMenuButton"
                                                data-mdb-toggle="dropdown"
                                                aria-expanded="false"
                                            > 
                                                    <i class="fas fa-ellipsis-v"></i>
                                                </a>
                                                <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="dropdownMenuButton">
                                                    <li>
                                                        <a 
                                                            class="dropdown-item" 
                                                            asp-area="Admin" 
                                                            asp-controller="Users"
                                                            asp-action="ChangeUsername" 
                                                            asp-route-id="@user.Id"
                                                        >
                                                            <i class="fas fa-id-badge"></i> &nbsp; Change Username
                                                        </a>
                                                    </li>
                                                    <li>
                                                        <a 
                                                            class="dropdown-item" 
                                                            asp-area="Admin" 
                                                            asp-controller="Users"
                                                            asp-action="ChangeEmail" 
                                                            asp-route-id="@user.Id"
                                                        >
                                                            <i class="fas fa-at"></i> &nbsp; Change Email
                                                        </a>
                                                    </li>
                                                    @if (!user.Roles.Any(role => role == ApplicationUserRole.SuperAdmin))
                                                    {
                                                        <li>
                                                            <a 
                                                                class="dropdown-item" 
                                                                asp-area="Admin" 
                                                                asp-controller="Users"
                                                                asp-action="ManageRoles" 
                                                                asp-route-id="@user.Id"
                                                            >
                                                                <i class="fas fa-shield-alt"></i> &nbsp; Manage Roles
                                                            </a>
                                                        </li>
                                                    }
                                                    @if (!user.Roles.Any(role => role == ApplicationUserRole.SuperAdmin))
                                                    {
                                                        <li>
                                                            <a 
                                                                class="dropdown-item text-danger" 
                                                                asp-area="Admin" 
                                                                asp-controller="Users"
                                                                asp-action="Lockout" 
                                                                asp-route-id="@user.Id"
                                                            >
                                                                <i class="fas fa-ban"></i> &nbsp; Lockout
                                                            </a>
                                                        </li>
                                                    }

                                                    @if (User.IsInRole(ApplicationUserRole.SuperAdmin) && !user.Roles.Any(role => role == ApplicationUserRole.SuperAdmin))
                                                    {
                                                        <li>
                                                            <a 
                                                                class="dropdown-item text-danger" 
                                                                data-mdb-toggle="modal" 
                                                                data-mdb-target="#deleteModal" 
                                                                data-id="@user.Id"
                                                            >
                                                                <i class="fas fa-trash-alt"></i> &nbsp; Delete
                                                            </a> 
                                                        </li>
                                                    }

                                                </ul>
                                            </div>
                                        }
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
                <!-- Card Footer -->
                <div class="card-footer" style="border-top: none;">
                    <div class="container">
                        <div class="row align-items-center pt-2">
                            <div class="col d-flex justify-content-end">
                                @{
                                    var prevDisabled = !Model.HasPreviousPage ? "disabled" : "";
                                    var nextDisabled = !Model.HasNextPage ? "disabled" : "";
                                }
                                <nav aria-label="...">
                                    <ul class="pagination">
                                        <li class="page-item @prevDisabled">
                                            <a class="page-link"
                                                asp-area="Admin" 
                                                asp-controller="Users"
                                                asp-action="Index"
                                                asp-route-sort="@ViewData["CurrentSort"]"
                                                asp-route-page="@(Model.PageIndex - 1)"
                                                asp-route-filter="@ViewData["CurrentFilter"]"
                                                asp-route-size="@ViewData["PageSize"]"
                                            >
                                                Previous
                                            </a>
                                        </li>
                                        @{
                                            for (int pageNum = 0; pageNum < Model.TotalPages; pageNum++)
                                            {
                                                var isCurrentPage = (pageNum + 1) == Model.PageIndex;
                                                var activePageClass = isCurrentPage ? "active" : "";

                                                <li class="page-item @activePageClass">
                                                    <a class="page-link"
                                                        asp-area="Admin" 
                                                        asp-controller="Users"
                                                        asp-action="Index"
                                                        asp-route-sort="@ViewData["CurrentSort"]"
                                                        asp-route-page="@(pageNum + 1)"
                                                        asp-route-filter="@ViewData["CurrentFilter"]"
                                                        asp-route-size="@ViewData["PageSize"]"
                                                    >
                                                        @(pageNum + 1) 
                                                        @if (isCurrentPage)
                                                        {
                                                            <span class="visually-hidden">(current)</span>
                                                        }
                                                    </a>
                                                </li>
                                            }
                                        }
                                        <li class="page-item @nextDisabled">
                                            <a class="page-link"
                                                asp-area="Admin" 
                                                asp-controller="Users"
                                                asp-action="Index"
                                                asp-route-sort="@ViewData["CurrentSort"]"
                                                asp-route-page="@(Model.PageIndex + 1)"
                                                asp-route-filter="@ViewData["CurrentFilter"]"
                                                asp-route-size="@ViewData["PageSize"]"
                                            >
                                                Next
                                            </a>
                                        </li>
                                    </ul>
                                </nav>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<partial name="_DeleteModal" />

@section Scripts {
    <script src="~/js/timezone-offset-cookie.js"></script>
    <script src="~/js/admin-users-index.js"></script>
}